<div id="doc" class="markdown-body container-fluid comment-enabled"><h1 id="107-OS-homework-2-å¯¦ä½œSystem-Call">107 OS homework 2 å¯¦ä½œSystem Call</h1><blockquote>
<p>çµ„é•·ï¼šB10532014 ç‹æ˜Ÿè˜‹<br>
çµ„å“¡ï¼šB10515008 è³ˆå¬¿å©·<br>
github: <a href="https://github.com/hsingpingwang/xv6-public" target="_blank" rel="noopener">https://github.com/hsingpingwang/xv6-public</a></p>
</blockquote><hr><h1 id="ğŸ¤”-åŠŸèƒ½èªªæ˜">ğŸ¤” åŠŸèƒ½èªªæ˜</h1><p>clone()ä½¿child processå¯ä»¥åˆ†äº«éƒ¨åˆ†çš„execution contextçµ¦calling processã€‚</p><hr><h1 id="ğŸ˜‡-å¯¦ä½œéç¨‹ä¿®æ”¹å“ªäº›æª”æ¡ˆå«åœ–ç‰‡">ğŸ˜‡ å¯¦ä½œéç¨‹(ä¿®æ”¹å“ªäº›æª”æ¡ˆ[å«åœ–ç‰‡])</h1><h2 id="åŸæœ‰æª”æ¡ˆ">åŸæœ‰æª”æ¡ˆ</h2><h3 id="1-syscallh">1.  syscall.h</h3><p>æ–°å¢system callçš„defineå’Œå…¶æ•¸å­—<br>
<img src="https://i.imgur.com/WzN4QfH.png" alt=""></p><h3 id="2-defsh">2.  defs.h</h3><p>å®£å‘Š<br>
<img src="https://i.imgur.com/P8x9zrC.png" alt=""></p><h3 id="3-userh">3.  user.h</h3><p>åŠ å…¥å‡½å¼å®£å‘Š<br>
<img src="https://i.imgur.com/CS1cGkY.png" alt=""></p><h3 id="4-sysprocc">4.  sysproc.c</h3><p>å›å‚³å‡½å¼<br>
<img src="https://i.imgur.com/w9MHyb6.png" alt=""></p><h3 id="5-usysS">5.  usys.S</h3><p>åŠ å…¥æ–°syscall<br>
<img src="https://i.imgur.com/Rcwsgmo.png" alt=""></p><h3 id="6-syscallc">6.  syscall.c</h3><p>é€²è¡Œ system call çš„å®£å‘Š<br>
<img src="https://i.imgur.com/tF8Erd1.png" alt=""></p><h3 id="7-procc">7.  proc.c</h3><p>åŠ å…¥<code>clone(void)</code></p><pre><code class="c hljs"><span class="token keyword">int</span>
<span class="token function">clone</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	uint ustack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>fcn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>stack<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fcn<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fcn<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argptr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>arg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argptr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> pid<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> proc <span class="token operator">*</span>np<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack<span class="token operator">%</span>PGSIZE<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>sz <span class="token operator">-</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack<span class="token punctuation">)</span> <span class="token operator">&lt;</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Allocate process.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>np <span class="token operator">=</span> <span class="token function">allocproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token comment">// Copy process state from p.</span>
	np<span class="token operator">-&gt;</span>pgdir <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>pgdir<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>sz <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>sz<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> proc<span class="token punctuation">;</span>
	<span class="token operator">*</span>np<span class="token operator">-&gt;</span>tf <span class="token operator">=</span> <span class="token operator">*</span>proc<span class="token operator">-&gt;</span>tf<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>esp <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack<span class="token operator">+</span>PGSIZE<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tstack <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack<span class="token punctuation">;</span>
	ustack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
	ustack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>esp <span class="token operator">-</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token function">copyout</span><span class="token punctuation">(</span>np<span class="token operator">-&gt;</span>pgdir<span class="token punctuation">,</span> np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>esp<span class="token punctuation">,</span> ustack<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token comment">//Clear %eax so that fork returns 0 in the child.</span>
	np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>eax <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>eip <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>fcn<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>ebp <span class="token operator">=</span> np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>esp<span class="token punctuation">;</span>

	 <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NOFILE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	    <span class="token keyword">if</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	      np<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">filedup</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>cwd <span class="token operator">=</span> <span class="token function">idup</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	pid <span class="token operator">=</span> np<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>state <span class="token operator">=</span> RUNNABLE<span class="token punctuation">;</span>
	<span class="token function">safestrcpy</span><span class="token punctuation">(</span>np<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> proc<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="æ–°å¢æª”æ¡ˆ">æ–°å¢æª”æ¡ˆ</h2><h2 id="clonec">clone.c</h2><p>å¯¦ä½œclone</p><pre><code class="c hljs"><span class="token comment">/* clone copies file descriptors, but doesn't share */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"types.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"user.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"fcntl.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"x86.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">undef</span> NULL</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NULL ((void*)0)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> PGSIZE (4096)</span>

<span class="token keyword">int</span> ppid<span class="token punctuation">;</span>
<span class="token keyword">volatile</span> uint newfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> assert(x) if (x) {} else { \
   printf(1, "%s: %d ", __FILE__, __LINE__); \
   printf(1, "assert failed (%s)\n", # x); \
   printf(1, "TEST FAILED\n"); \
   kill(ppid); \
   exit(); \
}</span>

<span class="token keyword">void</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   ppid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token operator">*</span>stack <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>PGSIZE<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">assert</span><span class="token punctuation">(</span>stack <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span>
     stack <span class="token operator">=</span> stack <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4096</span> <span class="token operator">-</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"tmp"</span><span class="token punctuation">,</span> O_WRONLY<span class="token operator">|</span>O_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">assert</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"stack before = %d\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> clone_pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"clone pid=%d\n"</span><span class="token punctuation">,</span>clone_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">assert</span><span class="token punctuation">(</span>clone_pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>newfd<span class="token punctuation">,</span> <span class="token string">"goodbye\n"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"TEST PASSED\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>
<span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"hello\n"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">xchg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>newfd<span class="token punctuation">,</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"tmp2"</span><span class="token punctuation">,</span> O_WRONLY<span class="token operator">|</span>O_CREATE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><hr><h1 id="ğŸƒ-Demoç•«é¢">ğŸƒ Demoç•«é¢</h1><p><img src="https://i.imgur.com/fWsp2iW.jpg" alt=""></p><hr><h1 id="ğŸ»-é æœŸæˆæ•ˆã€æƒ…å¢ƒèªªæ˜ï¼ˆæ€éº¼ç”¨ã€èª°ç”¨ï¼‰">ğŸ» é æœŸæˆæ•ˆã€æƒ…å¢ƒèªªæ˜ï¼ˆæ€éº¼ç”¨ã€èª°ç”¨ï¼‰</h1><p>ä¸»è¦ç”¨é€”æ˜¯implement threadsã€‚</p><pre><code class="c hljs"><span class="token comment">// Copy process state from p.</span>
	np<span class="token operator">-&gt;</span>pgdir <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>pgdir<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>sz <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>sz<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> proc<span class="token punctuation">;</span>
	<span class="token operator">*</span>np<span class="token operator">-&gt;</span>tf <span class="token operator">=</span> <span class="token operator">*</span>proc<span class="token operator">-&gt;</span>tf<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>esp <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack<span class="token operator">+</span>PGSIZE<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tstack <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>stack<span class="token punctuation">;</span>
	ustack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
	ustack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>esp <span class="token operator">-</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token function">copyout</span><span class="token punctuation">(</span>np<span class="token operator">-&gt;</span>pgdir<span class="token punctuation">,</span> np<span class="token operator">-&gt;</span>tf<span class="token operator">-&gt;</span>esp<span class="token punctuation">,</span> ustack<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ç”±ä¸Šæ®µç¨‹å¼å¯è¦‹ï¼Œä»–æœƒæŠŠcalling processè¤‡è£½ï¼Œç„¶å¾Œå›å‚³pidã€‚</p><hr><h1 id="ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦-çµ„å“¡åˆ†å·¥">ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦ çµ„å“¡åˆ†å·¥</h1><p>ç‹æ˜Ÿè˜‹ï¼šæŸ¥æ‰¾è³‡æ–™ã€ç¨‹å¼æ’°å¯«èˆ‡é™¤éŒ¯ã€åŸ·è¡Œçµæœã€ç·¨è¼¯å ±å‘Š<br>
è³ˆå¬¿å©·ï¼šæŸ¥æ‰¾è³‡æ–™ã€ç¨‹å¼æ’°å¯«èˆ‡é™¤éŒ¯ã€çµ±æ•´æª”æ¡ˆã€ç·¨è¼¯å ±å‘Š</p><hr></div>